def confirm_order(request):
    if request.method == 'POST':
        user_id = request.session.get('user_id')
        user = get_object_or_404(User, id=user_id)

        address_option = request.POST.get('address_option')

        if address_option == 'saved':
            profile = UserProfile.objects.get(user=user)
            address = f"{profile.address}, {profile.city}, {profile.state} - {profile.pincode}"
        else:
            new_address = request.POST.get('new_address')
            new_city = request.POST.get('new_city')
            new_state = request.POST.get('new_state')
            new_pincode = request.POST.get('new_pincode')
            address = f"{new_address}, {new_city}, {new_state} - {new_pincode}"

        # Calculate cart total
        cart_items = CartItem.objects.filter(user=user)
        total_amount = sum(item.medicine.price * item.quantity for item in cart_items)

        # Create order (COD method for now)
        order = Order.objects.create(
            user_id=user.id,
            address=address,
            amount=total_amount,
            payment_method='COD',
            is_paid=False
        )

        # Optional: Clear cart
        cart_items.delete()

        return render(request, 'order_success.html', {'order': order})

    return redirect('select_address')
